name: Build ZMK Firmware

on:
  push:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Zephyr Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends git cmake ninja-build gcc g++ \
            python3-dev python3-pip python3-setuptools python3-wheel python3-venv \
            device-tree-compiler wget
          pip3 install west
          west init -l config
          west update
          west zephyr-export
          pip3 install -r zephyr/scripts/requirements.txt

      - name: Build Firmware
        run: |
          west build -b nice_nano_v2 -- -DSHIELD=kestrel47 -DZMK_CONFIG="$(pwd)/config"

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: kestrel47_firmware
          path: build/zephyr/zmk.uf2
